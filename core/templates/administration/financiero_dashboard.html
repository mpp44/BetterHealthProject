<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Panel Financiero</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f4f7f9;
            color: #333;
            line-height: 1.6;
        }
        .container {
            display: flex;
            min-height: 100vh;
        }
        /* Menú lateral izquierdo */
        aside {
            background: #2c3e50;
            color: #ecf0f1;
            width: 250px;
            padding: 30px 20px;
        }

        aside h2 {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        aside ul {
            list-style: none;
        }

        aside ul li {
            margin-bottom: 15px;
        }

        aside ul li a {
            color: #ecf0f1;
            text-decoration: none;
            display: block;
            padding: 10px 15px;
            border-radius: 4px;
            transition: background 0.3s;
        }

        aside ul li a:hover {
            background: #34495e;
        }

        .menu-link {
            display: flex;
            align-items: center;
            gap: 10px; /* Espacio entre el icono y el texto */
            padding: 10px 15px;
            border-radius: 4px;
            transition: background 0.3s;
            color: #ecf0f1;
            text-decoration: none;
        }

        .menu-link:hover {
            background: #34495e;
        }

        .menu-link .icon {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
            color: #ecf0f1;
        }
        main {
            flex: 1;
            padding: 30px 40px;
        }
        main h1 {
            margin-bottom: 20px;
        }
        .card {
            background: #fff;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            border: 1px solid #ececec;
            box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.1);
        }
        .card h3 {
            margin-bottom: 15px;
        }
        .section {
            display: none;
        }
        .section.active {
            display: block;
        }
        form label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        form input,
        form select,
        form textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        form button,
        form input[type="submit"] {
            background: #2c3e50;
            border: none;
            color: #fff;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
        }
        form button:hover,
        form input[type="submit"]:hover {
            background: #34495e;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        table th, table td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: left;
        }
        table th {
            background-color: #ecf0f1;
        }
        .text-center {
            text-align: center;
        }
        .mb-3 {
            margin-bottom: 1.5rem;
        }
        .filter-row {
            display: flex;
            gap: 20px;
            align-items: flex-end;
            margin-top: 10px;
        }
        .filter-row select, .filter-row input {
            width: auto;
        }
    </style>
</head>
<body>
<div class="container">
    <aside>
        <h2>Better Health</h2>
        <ul>
            <li>
                <a href="#" onclick="showSection('facturas')" class="menu-link">
                    <svg class="w-6 h-6 text-gray-800 dark:text-white" aria-hidden="true"
                         xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor"
                         viewBox="0 0 24 24">
                        <path fill-rule="evenodd"
                              d="M5.617 2.076a1 1 0 0 1 1.09.217L8 3.586l1.293-1.293a1 1 0 0 1 1.414 0L12 3.586l1.293-1.293a1 1 0 0 1 1.414 0L16 3.586l1.293-1.293A1 1 0 0 1 19 3v18a1 1 0 0 1-1.707.707L16 20.414l-1.293 1.293a1 1 0 0 1-1.414 0L12 20.414l-1.293 1.293a1 1 0 0 1-1.414 0L8 20.414l-1.293 1.293A1 1 0 0 1 5 21V3a1 1 0 0 1 .617-.924ZM9 7a1 1 0 0 0 0 2h6a1 1 0 1 0 0-2H9Zm0 4a1 1 0 1 0 0 2h6a1 1 0 1 0 0-2H9Zm0 4a1 1 0 1 0 0 2h6a1 1 0 1 0 0-2H9Z"
                              clip-rule="evenodd"/>
                    </svg>
                    <span><b>Facturas</b></span>
                </a>
            </li>
            <li>
                <a href="#" onclick="showSection('analisis')" class="menu-link">
                    <svg class="w-6 h-6 text-gray-800 dark:text-white" aria-hidden="true"
                         xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor"
                         viewBox="0 0 24 24">
                        <path fill-rule="evenodd"
                              d="M9 15a6 6 0 1 1 12 0 6 6 0 0 1-12 0Zm3.845-1.855a2.4 2.4 0 0 1 1.2-1.226 1 1 0 0 1 1.992-.026c.426.15.809.408 1.111.749a1 1 0 1 1-1.496 1.327.682.682 0 0 0-.36-.213.997.997 0 0 1-.113-.032.4.4 0 0 0-.394.074.93.93 0 0 0 .455.254 2.914 2.914 0 0 1 1.504.9c.373.433.669 1.092.464 1.823a.996.996 0 0 1-.046.129c-.226.519-.627.94-1.132 1.192a1 1 0 0 1-1.956.093 2.68 2.68 0 0 1-1.227-.798 1 1 0 1 1 1.506-1.315.682.682 0 0 0 .363.216c.038.009.075.02.111.032a.4.4 0 0 0 .395-.074.93.93 0 0 0-.455-.254 2.91 2.91 0 0 1-1.503-.9c-.375-.433-.666-1.089-.466-1.817a.994.994 0 0 1 .047-.134Zm1.884.573.003.008c-.003-.005-.003-.008-.003-.008Zm.55 2.613s-.002-.002-.003-.007a.032.032 0 0 1 .003.007ZM4 14a1 1 0 0 1 1 1v4a1 1 0 1 1-2 0v-4a1 1 0 0 1 1-1Zm3-2a1 1 0 0 1 1 1v6a1 1 0 1 1-2 0v-6a1 1 0 0 1 1-1Zm6.5-8a1 1 0 0 1 1-1H18a1 1 0 0 1 1 1v3a1 1 0 1 1-2 0v-.796l-2.341 2.049a1 1 0 0 1-1.24.06l-2.894-2.066L6.614 9.29a1 1 0 1 1-1.228-1.578l4.5-3.5a1 1 0 0 1 1.195-.025l2.856 2.04L15.34 5h-.84a1 1 0 0 1-1-1Z"
                              clip-rule="evenodd"/>
                    </svg>

                    <span><b>Análisis</b></span>
                </a>
            </li>
            <li>
                <a href="{% url 'admin_logout' %}" class="menu-link">
                    <svg class="w-6 h-6 text-gray-800 dark:text-white" aria-hidden="true"
                         xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M18 18V6h-5v12h5Zm0 0h2M4 18h2.5m3.5-5.5V12M6 6l7-2v16l-7-2V6Z"/>
                    </svg>
                    <span>Cerrar sesión</span>
                </a>
            </li>
        </ul>
    </aside>
    <main>
        <h1>Bienvenido al Panel Financiero</h1>
        <div id="facturas" class="section {% if active_section == 'facturas' %}active{% endif %}">
            <div class="card">
                <h3>Facturas</h3>
                <table>
                    <thead>
                    <tr>
                        <th>ID</th>
                        <th>Servicio</th>
                        <th>Usuario</th>
                        <th>Fecha</th>
                        <th>Importe</th>
                        <th>Pagado</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for factura in facturas %}
                    <tr>
                        <td>{{ factura.id }}</td>
                        <td>{{ factura.appointment.service.name }}</td>
                        <td>{{ factura.appointment.user.username }}</td>
                        <td>{{ factura.issued_date|date:"d/m/Y" }}</td>
                        <td>{{ factura.amount }} €</td>
                        <td>{{ factura.is_paid|yesno:"Sí,No" }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center">No hay facturas registradas.</td>
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <div id="analisis" class="section {% if active_section == 'analisis' %}active{% endif %}">
          <div class="card">
            <h3>Análisis Financiero</h3>
            <form method="post">
              {% csrf_token %}
              <input type="hidden" name="analisis" value="1">
              <div class="filter-row">
                <label for="period">Periodo:</label>
                <select name="period" id="period">
                  <option value="monthly" {% if selected_period == 'monthly' %}selected{% endif %}>Mensual</option>
                  <option value="annual" {% if selected_period == 'annual' %}selected{% endif %}>Anual</option>
                </select>
                <input type="submit" value="Actualizar">
              </div>
            </form>

            {% if line_labels and line_data %}
              <div class="chart-container">
                <canvas id="lineChart"></canvas>
              </div>
            {% else %}
              <p class="text-center">No hay datos para mostrar en el gráfico de líneas.</p>
            {% endif %}

            <h4 class="mt-4">Servicios más rentables ({{ selected_period }})</h4>
            <table>
              <thead>
                <tr><th>Servicio</th><th>Total (€)</th></tr>
              </thead>
              <tbody>
                {% for r in ranking_services %}
                  <tr><td>{{ r.service }}</td><td>{{ r.total }}</td></tr>
                {% empty %}
                  <tr><td colspan="2" class="text-center">No hay datos.</td></tr>
                {% endfor %}
              </tbody>
            </table>

            <h4 class="mt-4">Distribución de facturación</h4>
            {% if pie_labels and pie_data %}
              <div class="chart-container">
                <canvas id="pieChart"></canvas>
              </div>
            {% else %}
              <p class="text-center">No hay datos para mostrar en el gráfico circular.</p>
            {% endif %}
          </div>
        </div>
    </main>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    if ({{ line_labels|length }} > 0) {
      new Chart(document.getElementById('lineChart').getContext('2d'), {
        type: 'line',
        data: { labels: {{ line_labels|safe }}, datasets: [{ label: 'Facturación', data: {{ line_data|safe }}, fill: false, tension: 0.1 }] },
        options: { responsive: true, maintainAspectRatio: false }
      });
    }
    if ({{ pie_labels|length }} > 0) {
      new Chart(document.getElementById('pieChart').getContext('2d'), {
        type: 'pie',
        data: { labels: {{ pie_labels|safe }}, datasets: [{ data: {{ pie_data|safe }} }] },
        options: { responsive: true, maintainAspectRatio: false }
      });
    }
  });
</script>
<script>
    function showSection(sectionId) {
        const sections = document.querySelectorAll('.section');
        sections.forEach(section => {
            section.classList.remove('active');
        });
        document.getElementById(sectionId).classList.add('active');
    }
</script>
</body>
</html>
